{% extends "base.html" %}

{% block title %}Dashboard - Tunnel Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-md btn-success" data-bs-toggle="modal" data-bs-target="#addServerModal">
            <i class="fas fa-plus-circle"></i> Add Server Instance
        </button>
        <button type="button" class="btn btn-md btn-success ms-2" data-bs-toggle="modal" data-bs-target="#addClientModal">
            <i class="fas fa-plus-circle"></i> Add Client Instance
        </button>
    </div>
</div>

<!-- Server Instances -->
<h2>Server Instances</h2>
<div class="row">
    {% for name, server in servers.items() %}
    <div class="col-12 mb-4">
        <div class="card" id="server-{{ name }}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong>{{ name }}</strong>
                <span id="server-{{ name }}-status" class="badge bg-{{ 'success' if server.status == 'active' else 'warning' if server.status == 'running' else 'danger' }}">{{ server.status | capitalize }}</span>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <p class="card-text">
                        <strong>Address:</strong> {{ server.addr }}
                    </p>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="autoRestartSwitch-server-{{ name }}" onchange="location.href='{{ url_for('toggle_auto_restart', instance_type='server', instance_name=name) }}'" {% if server.auto_restart %}checked{% endif %}>
                        <label class="form-check-label" for="autoRestartSwitch-server-{{ name }}">Auto-Restart</label>
                    </div>
                </div>
                <h5>Services</h5>
                <ul class="list-group list-group-flush">
                    {% for t_name, tunnel in tunnels.items() if tunnel['parent_instance'] == name and tunnel['service_type'] == 'server_service' %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ t_name }} &rarr; {{ tunnel['server_bind_addr'] }}
                        <a href="{{ url_for('remove_service', service_name=t_name) }}" onclick="return confirm('Are you sure?');" class="btn btn-sm btn-danger"><i class="fas fa-trash-alt"></i></a>
                    </li>
                    {% endfor %}
                </ul>
                {% if server.transport_protocol == 'noise' %}
                <div class="mt-3">
                    <strong>Public Key:</strong> <code>{{ server.public_key }}</code>
                    <a href="{{ url_for('regenerate_key', instance_type='server', instance_name=name) }}" class="btn btn-sm btn-warning"><i class="fas fa-sync-alt"></i> Regenerate</a>
                </div>
                {% elif server.transport_protocol == 'tls' %}
                <div class="mt-3">
                    <a href="{{ url_for('regenerate_cert', instance_type='server', instance_name=name) }}" class="btn btn-sm btn-warning"><i class="fas fa-sync-alt"></i> Regenerate Certificate</a>
                </div>
                {% endif %}
            </div>
            <div class="card-footer text-muted d-flex justify-content-between">
                <div>
                    {% if server.status == 'stopped' %}
                    <a href="{{ url_for('start_instance', instance_type='server', instance_name=name) }}" class="btn btn-sm btn-success"><i class="fas fa-play"></i> Start</a>
                    {% else %}
                    <a href="{{ url_for('stop_instance', instance_type='server', instance_name=name) }}" class="btn btn-sm btn-warning"><i class="fas fa-stop"></i> Stop</a>
                    {% endif %}
                    <a href="{{ url_for('remove_instance', instance_type='server', instance_name=name) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?');"><i class="fas fa-trash-alt"></i> Remove</a>
                    <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#editInstanceModal-server-{{ name }}"><i class="fas fa-edit"></i> Edit</button>
                </div>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addServiceModal-server-{{ name }}"><i class="fas fa-plus"></i> Add Port</button>
            </div>
        </div>
    </div>
    {% else %}
    <p>No server instances configured.</p>
    {% endfor %}
</div>

<!-- Client Instances -->
<h2 class="mt-4">Client Instances</h2>
<div class="row">
    {% for name, client in clients.items() %}
    <div class="col-12 mb-4">
        <div class="card" id="client-{{ name }}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong>{{ name }}</strong>
                <span id="client-{{ name }}-status" class="badge bg-{{ 'success' if client.status == 'active' else 'warning' if client.status == 'running' else 'danger' }}">{{ client.status | capitalize }}</span>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <p class="card-text">
                        <strong>Address:</strong> {{ client.addr }}
                    </p>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="autoRestartSwitch-client-{{ name }}" onchange="location.href='{{ url_for('toggle_auto_restart', instance_type='client', instance_name=name) }}'" {% if client.auto_restart %}checked{% endif %}>
                        <label class="form-check-label" for="autoRestartSwitch-client-{{ name }}">Auto-Restart</label>
                    </div>
                </div>
                <h5>Services</h5>
                <ul class="list-group list-group-flush">
                    {% for t_name, tunnel in tunnels.items() if tunnel['parent_instance'] == name and tunnel['service_type'] == 'client_service' %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ t_name }} &rarr; {{ tunnel['local_addr'] }}
                        <a href="{{ url_for('remove_service', service_name=t_name) }}" onclick="return confirm('Are you sure?');" class="btn btn-sm btn-danger"><i class="fas fa-trash-alt"></i></a>
                    </li>
                    {% endfor %}
                </ul>
                {% if client.transport_protocol == 'noise' %}
                <div class="mt-3">
                    <strong>Public Key:</strong> <code>{{ client.public_key }}</code>
                    <a href="{{ url_for('regenerate_key', instance_type='client', instance_name=name) }}" class="btn btn-sm btn-warning"><i class="fas fa-sync-alt"></i> Regenerate</a>
                </div>
                {% elif client.transport_protocol == 'tls' %}
                <div class="mt-3">
                    <a href="{{ url_for('regenerate_cert', instance_type='client', instance_name=name) }}" class="btn btn-sm btn-warning"><i class="fas fa-sync-alt"></i> Regenerate Certificate</a>
                </div>
                {% endif %}
            </div>
            <div class="card-footer text-muted d-flex justify-content-between">
                <div>
                    {% if client.status == 'stopped' %}
                    <a href="{{ url_for('start_instance', instance_type='client', instance_name=name) }}" class="btn btn-sm btn-success"><i class="fas fa-play"></i> Start</a>
                    {% else %}
                    <a href="{{ url_for('stop_instance', instance_type='client', instance_name=name) }}" class="btn btn-sm btn-warning"><i class="fas fa-stop"></i> Stop</a>
                    {% endif %}
                    <a href="{{ url_for('remove_instance', instance_type='client', instance_name=name) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?');"><i class="fas fa-trash-alt"></i> Remove</a>
                    <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#editInstanceModal-client-{{ name }}"><i class="fas fa-edit"></i> Edit</button>
                </div>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addServiceModal-client-{{ name }}"><i class="fas fa-plus"></i> Add Port</button>
            </div>
        </div>
    </div>
    {% else %}
    <p>No client instances configured.</p>
    {% endfor %}
</div>


<!-- Ports Traffic -->
<h2 class="mt-4">Ports Traffic</h2>
<div class="row">
    <div class="col">
        <h4>Server Ports</h4>
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Port</th>
                    <th>Parent Instance</th>
                    <th>Traffic (Sent/Recv)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for t_name, tunnel in tunnels.items() if tunnel['service_type'] == 'server_service' %}
                <tr>
                    <td>{{ tunnel['server_bind_addr'].split(':')[-1] }}</td>
                    <td>{{ tunnel['parent_instance'] }}</td>
                    <td id="server-{{ t_name }}-traffic">
                        &#8593; {{ servers.get(tunnel['parent_instance'], {}).get('services', {}).get(t_name, {}).get('traffic', {}).get('sent') | human_readable_bytes }} <br>
                        &#8595; {{ servers.get(tunnel['parent_instance'], {}).get('services', {}).get(t_name, {}).get('traffic', {}).get('recv') | human_readable_bytes }}
                    </td>
                    <td><a href="{{ url_for('reset_traffic', service_name=t_name) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?');"><i class="fas fa-sync-alt"></i> Reset</a></td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4">No server ports in use.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="col">
        <h4>Client Ports</h4>
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Port</th>
                    <th>Parent Instance</th>
                    <th>Traffic (Sent/Recv)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for t_name, tunnel in tunnels.items() if tunnel['service_type'] == 'client_service' %}
                <tr>
                    <td>{{ tunnel['local_addr'].split(':')[-1] }}</td>
                    <td>{{ tunnel['parent_instance'] }}</td>
                    <td id="client-{{ t_name }}-traffic">
                        &#8593; {{ clients.get(tunnel['parent_instance'], {}).get('services', {}).get(t_name, {}).get('traffic', {}).get('sent') | human_readable_bytes }} <br>
                        &#8595; {{ clients.get(tunnel['parent_instance'], {}).get('services', {}).get(t_name, {}).get('traffic', {}).get('recv') | human_readable_bytes }}
                    </td>
                    <td><a href="{{ url_for('reset_traffic', service_name=t_name) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?');"><i class="fas fa-sync-alt"></i> Reset</a></td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4">No client ports in use.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


<!-- Modals -->
<!-- Add Server Modal -->
<div class="modal fade" id="addServerModal" tabindex="-1" aria-labelledby="addServerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addServerModalLabel">New Server Instance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{{ url_for('add_instance') }}">
                <div class="modal-body">
                    <input type="hidden" name="instance_type" value="server">
                    <div class="mb-3"><label class="form-label">Name (optional):</label><input type="text" class="form-control" name="name" placeholder="e.g., main_server"></div>
                    <div class="mb-3"><label class="form-label">Listen Port:</label><input type="text" class="form-control" name="port" required></div>
                    <div class="mb-3"><label class="form-label">Default Token (optional):</label><input type="text" class="form-control" name="token" placeholder="Default: RezaAb"></div>
                    <div class="mb-3">
                        <label class="form-label">Transport Protocol:</label>
                        <select class="form-select" name="transport_protocol">
                            <option value="tcp" selected>TCP</option>
                            <option value="tls">TLS</option>
                            <option value="noise">Noise</option>
                        </select>
                    </div>
                    <div class="form-check"><input type="checkbox" class="form-check-input" name="auto_restart" checked> <label class="form-check-label">Auto-Restart on Failure</label></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Create Server</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Client Modal -->
<div class="modal fade" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addClientModalLabel">New Client Instance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{{ url_for('add_instance') }}">
                <div class="modal-body">
                    <input type="hidden" name="instance_type" value="client">
                    <div class="mb-3"><label class="form-label">Name (optional):</label><input type="text" class="form-control" name="name" placeholder="e.g., home_pc"></div>
                    <div class="mb-3"><label class="form-label">Remote Address (IP only):</label><input type="text" class="form-control" name="address" required></div>
                    <div class="mb-3"><label class="form-label">Remote Port:</label><input type="text" class="form-control" name="port" required></div>
                    <div class="mb-3"><label class="form-label">Default Token (optional):</label><input type="text" class="form-control" name="token" placeholder="Default: RezaAb"></div>
                    <div class="mb-3">
                        <label class="form-label">Transport Protocol:</label>
                        <select class="form-select" name="transport_protocol">
                            <option value="tcp" selected>TCP</option>
                            <option value="tls">TLS</option>
                            <option value="noise">Noise</option>
                        </select>
                    </div>
                    <div class="mb-3"><label class="form-label">Remote Public Key (for Noise protocol):</label><input type="text" class="form-control" name="remote_public_key"></div>
                    <div class="form-check"><input type="checkbox" class="form-check-input" name="auto_restart" checked> <label class="form-check-label">Auto-Restart on Failure</label></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Create Client</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Instance Modals -->
{% for name, server in servers.items() %}
<div class="modal fade" id="editInstanceModal-server-{{ name }}" tabindex="-1" aria-labelledby="editInstanceModalLabel-server-{{ name }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editInstanceModalLabel-server-{{ name }}">Edit Server Instance: {{ name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{{ url_for('edit_instance') }}">
                <div class="modal-body">
                    <input type="hidden" name="instance_type" value="server">
                    <input type="hidden" name="instance_name" value="{{ name }}">
                    <div class="mb-3"><label class="form-label">Listen Port:</label><input type="text" class="form-control" name="port" value="{{ server.addr.split(':')[-1] }}" required></div>
                    <div class="mb-3">
                        <label class="form-label">Transport Protocol:</label>
                        <select class="form-select" name="transport_protocol">
                            <option value="tcp" {% if server.transport_protocol == 'tcp' %}selected{% endif %}>TCP</option>
                            <option value="tls" {% if server.transport_protocol == 'tls' %}selected{% endif %}>TLS</option>
                            <option value="noise" {% if server.transport_protocol == 'noise' %}selected{% endif %}>Noise</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

{% for name, client in clients.items() %}
<div class="modal fade" id="editInstanceModal-client-{{ name }}" tabindex="-1" aria-labelledby="editInstanceModalLabel-client-{{ name }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editInstanceModalLabel-client-{{ name }}">Edit Client Instance: {{ name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{{ url_for('edit_instance') }}">
                <div class="modal-body">
                    <input type="hidden" name="instance_type" value="client">
                    <input type="hidden" name="instance_name" value="{{ name }}">
                    <div class="mb-3"><label class="form-label">Remote Address (IP only):</label><input type="text" class="form-control" name="address" value="{{ client.addr.split(':')[0] }}" required></div>
                    <div class="mb-3"><label class="form-label">Remote Port:</label><input type="text" class="form-control" name="port" value="{{ client.addr.split(':')[-1] }}" required></div>
                    <div class="mb-3">
                        <label class="form-label">Transport Protocol:</label>
                        <select class="form-select" name="transport_protocol">
                            <option value="tcp" {% if client.transport_protocol == 'tcp' %}selected{% endif %}>TCP</option>
                            <option value="tls" {% if client.transport_protocol == 'tls' %}selected{% endif %}>TLS</option>
                            <option value="noise" {% if client.transport_protocol == 'noise' %}selected{% endif %}>Noise</option>
                        </select>
                    </div>
                    <div class="mb-3"><label class="form-label">Remote Public Key (for Noise protocol):</label><input type="text" class="form-control" name="remote_public_key" value="{{ client.public_key }}"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Add Service Modals -->
{% for name, instance in servers.items() %}
<div class="modal fade" id="addServiceModal-server-{{ name }}" tabindex="-1" aria-labelledby="addServiceModalLabel-server-{{ name }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addServiceModalLabel-server-{{ name }}">Add Service to {{ name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{{ url_for('add_service') }}">
                <div class="modal-body">
                    <input type="hidden" name="instance_type" value="server">
                    <input type="hidden" name="parent_instance" value="{{ name }}">
                    <div class="mb-3"><label class="form-label">Port:</label><input type="text" class="form-control" name="port" required></div>
                    <div class="mb-3"><label class="form-label">Service Name (optional):</label><input type="text" class="form-control" name="name"></div>
                    <div class="mb-3">
                        <label class="form-label">Protocol:</label>
                        <select class="form-select" name="protocol">
                            <option value="tcp" selected>TCP</option>
                            <option value="udp">UDP</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add Port</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% for name, instance in clients.items() %}
<div class="modal fade" id="addServiceModal-client-{{ name }}" tabindex="-1" aria-labelledby="addServiceModalLabel-client-{{ name }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addServiceModalLabel-client-{{ name }}">Add Service to {{ name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{{ url_for('add_service') }}">
                <div class="modal-body">
                    <input type="hidden" name="instance_type" value="client">
                    <input type="hidden" name="parent_instance" value="{{ name }}">
                    <div class="mb-3"><label class="form-label">Port:</label><input type="text" class="form-control" name="port" required></div>
                    <div class="mb-3"><label class="form-label">Service Name (optional):</label><input type="text" class="form-control" name="name"></div>
                    <div class="mb-3">
                        <label class="form-label">Protocol:</label>
                        <select class="form-select" name="protocol">
                            <option value="tcp" selected>TCP</option>
                            <option value="udp">UDP</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add Port</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const eventSource = new EventSource("{{ url_for('stream') }}");

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        // Update server instances
        updateInstances(data.servers, 'server');
        // Update client instances
        updateInstances(data.clients, 'client');
        // Update port traffic
        updatePortTraffic(data.servers, 'server');
        updatePortTraffic(data.clients, 'client');
    };

    function updateInstances(instancesData, instanceType) {
        for (const name in instancesData) {
            if (instancesData.hasOwnProperty(name)) {
                const instance = instancesData[name];
                const statusBadge = document.querySelector(`#${instanceType}-${name}-status`);
                if (statusBadge) {
                    statusBadge.className = `badge bg-${instance.status === 'active' ? 'success' : instance.status === 'running' ? 'warning' : 'danger'}`;
                    statusBadge.textContent = instance.status.charAt(0).toUpperCase() + instance.status.slice(1);
                }
            }
        }
    }

    function updatePortTraffic(instancesData, instanceType) {
        for (const instanceName in instancesData) {
            const instance = instancesData[instanceName];
            for (const serviceName in instance.services) {
                const trafficData = instance.services[serviceName].traffic;
                const trafficCellId = instanceType + '-' + serviceName + '-traffic';
                const trafficCell = document.getElementById(trafficCellId);
                if (trafficCell) {
                    trafficCell.innerHTML = `&#8593; ${trafficData.sent_hr} <br> &#8595; ${trafficData.recv_hr}`;
                }
            }
        }
    }
});
</script>
{% endblock %}
